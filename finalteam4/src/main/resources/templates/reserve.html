<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>

<link rel="stylesheet" th:href="@{/assets/css/style.css}">
<link th:href="@{/assets/css/datepicker.min.css}" rel="stylesheet"
	type="text/css" media="all">
<link rel="stylesheet" th:href="@{/assets/css/nice-select.css}">
<script type="text/JavaScript"
	src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>

<style>
#all {
	width: 400px;
	height: 200px;
	overflow: auto;
	border: 2px solid red;
}

#me {
	width: 400px;
	height: 200px;
	overflow: auto;
	border: 2px solid blue;
}

#to {
	width: 400px;
	height: 200px;
	overflow: auto;
	border: 2px solid green;
}

* {
	margin: 0;
	padding: 0;
}

a {
	text-decoration: none;
}

.navi_bar_area {
	width: 100%;
	height: 70px;
	background-color: #7696fd;
}

.content_area {
	width: 100%;
	min-height: 1000px;
}

table {
	border-collapse: collapse;
	width: 100%;
}

.table_text_align_center {
	text-align: center;
}

caption {
	visibility: hidden;
	width: 0;
	height: 0;
	font-size: 0;
	line-height: 0;
	overflow: hidden;
}

.content_subject {
	height: 110px;
	line-height: 110px;
	background-color: #5080bd;
	margin-bottom: 60px;
}

.content_subject span {
	padding-left: 30 px;
	display: inline-block;
	color: white;
	font-size: 50px;
	font-weight: bolder;
}

.content_totalCount_section {
	margin-bottom: 12px;
}

.content_btn_section {
	margin-top: 20px;
	text-align: center;
}

.content_btn_section a {
	color: #fefeff;
	min-width: 125px;
	padding: 2.5px 10px;
	display: inline-block;
	height: 39px;
	font-size: 23px;
	font-weight: bold;
	text-align: center;
	margin-right: -2px;
	line-height: 39px;
}

.subject_table {
	font-size: 14px;
	line-height: 20px;
	width: 100%;
	text-align: center;
}

th {
	text-align: center;
	color: #333;
	border-bottom: 1px solid #e7e7e7;
	border-top: 1px solid #3084d9;
	background: #f4f9fd;
	padding: 2px 0;
}

.td_width_1 {
	width: 1%;
}

.td_width_2 {
	width: 20%;
}

.td_width_3 {
	width: 12%;
}

.td_width_4 {
	width: 15%;
}

.cart_table {
	font-size: 14px;
	line-height: 20px;
}

.cart_table tr {
	height: 110px;
}

.price_td {
	padding-left: 5px;
}

.red_color {
	color: red;
}

.green_color {
	color: green;
}

.cart_table td {
	border-bottom: 1px solid #e7e7e7;
}

.quantity_div {
	position: relative;
	width: 42px;
	height: 25px;
	text-align: left;
	margin: 5px auto;
}

.quantity_input {
	position: absolute;
	width: 27px;
	height: 23px;
	text-align: center;
	border: 1px solid #c6c6c6;
	border-right: 0px;
	line-height: 19px;
	font-size: 16px;
	color: #4c4848;
	left: 0;
}

.quantity_btn {
	position: absolute;
	border: 1px solid #aaa;
	color: #FE6B00;
	width: 14px;
	height: 13px;
	padding: 0px;
	background-color: #fff;
	font-weight: bold;
	font-size: 7px;
	line-height: 6px;
	vertical-align: middle;
}

.plus_btn {
	top: 0;
	right: 0
}

.minus_btn {
	bottom: 0;
	right: 0
}

.quantity_modify_btn {
	border: 1px solid #d0d0d0;
	height: 25px;
	line-height: 13px;
	background-color: #fff;
	text-align: center;
	width: 46px;
	display: inline-block;
	padding: 3px 6px 2px;
	margin-top: 3px;
}

.table_text_align_center {
	text-align: center;
}

.content_total_section {
	background-color: rgb(227, 237, 247);
}

.total_wrap {
	width: 80%;
	margin: auto;
	padding: 10px 0 10px 0;
}

.total_wrap td {
	width: 50%;
}

.finalTotalPrice_span {
	color: #854A72;
	font-size: 17px;
	font-weight: bold;
}

.boundary_div {
	font-size: 0;
	border: 1px dotted #d1c7c7;
	margin: 5px 0 5px 0;
}

.input_size_20 {
	width: 20px;
	height: 20px;
}

.all_check_input {
	margin: 18px 0 18px 18px;
}

.all_chcek_span {
	padding-left: 8px;
	font-size: 20px;
	font-weight: bold;
}

table>tbody>tr>td>img {
	width: 100px;
	object-fit: cover;
}

table>tbody>tr>td>img:hover {
	width: 99px;
	border: 1px solid #FE6B00;
}

.btn:hover {
	background-color: #FE6B00;
	color: white;
}

table th, td, tr {
	text-align: center;
}

table.table td {
	border-bottom: solid #E9E9E9
}

table.table th {
	border-top: solid #E9E9E9
}

table.table th {
	border-bottom: solid #E9E9E9
}
</style>

</head>

<!-- 달력 한글 추가를 위해 커스텀 -->
<script type="text/javascript"
	src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
<link rel="stylesheet" type="text/css"
	href="/assets/css/jquery.datetimepicker.css">
<script src="/assets/js/jquery.js"></script>
<script src="/assets/js/jquery.datetimepicker.full.min.js"></script>

<script
	src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js"></script>
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ko.min.js"></script>

<body>
	<div class="wrapper">
		<div class="wrap">
			<div class="content_area">
				<div class="container-fluid">
					<h3 style="font-weight: 700; text-align: center; margin-top: 20px;">예약페이지</h3>
				</div>
				<div class="content_middle_section"></div>
				<div class="content_totalCount_section">

					<!-- 체크박스 전체 여부 -->
					<div class="all_check_input_div">
						<input type="checkbox" class="all_check_input input_size_20"
							checked="checked"><span class="all_chcek_span">전체선택</span>
					</div>

					<table class="table table-hover">
						<tbody>
							<tr>
								<th class="td_width_1"></th>
								<th class="td_width_2">메뉴 이미지</th>
								<th class="td_width_3">메뉴명</th>
								<th class="td_width_4">가격</th>
								<th class="td_width_4">수량</th>
								<th class="td_width_4">합계</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="c : ${menulist}">
								<td class="td_width_1 cart_info_td"><input type="checkbox"
									class="individual_cart_checkbox input_size_20"
									checked="checked"> <input type="hidden"
									class="individual_Price_input" th:value="${c.price}"> <input
									type="hidden" class="individual_Cnt_input" th:value="${c.cnt}">
									<input type="hidden" class="individual_totalPrice_input"
									th:value="${c.price*c.cnt}"> <input type="hidden"
									class="individual_itemId_input" th:value="${c.menuid}">
								</td>
								<td class="td_width_2"><img
									th:src="@{/menuimg/}+${c.menuimg}"
									style="width: 200px; height: 200px; border-radius: 60px;">
								</td>
								<td class="td_width_3" th:text="${c.menuname}">Item Name</td>
								<td class="td_width_4 price_td"
									th:text="${#numbers.formatInteger(c.price, 3, 'COMMA')}+'원'">
								</td>
								<td class="td_width_4 table_text_align_center">
									<div class="table_text_align_center quantity_div">
										<input type="text" th:value="${c.cnt}" class="quantity_input">
										<button class="quantity_btn plus_btn">+</button>
										<button class="quantity_btn minus_btn">-</button>
									</div>
									<button type="button" class="quantity_modify_btn"
										th:data-cartid="${c.cartid}" th:data-custid="${c.custid}"
										th:data-menuid="${c.menuid}" th:data-menuname="${c.menuname}"
										th:data-price="${c.price}" th:data-menuimg="${c.menuimg}">수정
									</button>
								</td>
								<td>
									<div>
										<span th:if="${c.cnt*c.price != 0}"
											th:text="${#numbers.formatInteger(c.cnt*c.price, 3, 'COMMA')}+'원'"></span>
										<span th:if="${c.cnt*c.price == 0}">0원</span>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
					<div class="picker-wrapper">
						<input type="text" class="datepicker" id="datetimepicker" name="datetimepicker">
					</div>
					<!-- 가격 종합 -->
					<div class="content_total_section">
						<div class="total_wrap">
							<table>
								<tr>
									<td>
										<table>
											<tr>
												<td>총 상품 가격</td>
												<td><span class="totalPrice_span">70000</span> 원</td>
											</tr>
											<tr>
												<td>총 주문 상품수</td>
												<td><span class="totalKind_span"></span>종&nbsp&nbsp<span
													class="totalCount_span"></span>개</td>
											</tr>
										</table>
									</td>
									<td>
										<table>
											<tr>
												<td></td>
												<td></td>
											</tr>
										</table>
									</td>
								</tr>
							</table>
							<div class="boundary_div">구분선</div>
							<table>
								<tr>
									<td>
										<table>
											<tbody>
												<tr>
													<td><strong>총 결제 예상 금액</strong></td>
													<td id=totalpricespan><span
														class="finalTotalPrice_span">70000</span> 원</td>
												</tr>
											</tbody>
										</table>
									</td>
								</tr>
							</table>
						</div>
					</div>
					<!-- 예약 버튼 영역 -->
					<div class="content_btn_section">
						<button type="button" id="reserve_btn2" class="btn btn-primary">예약하기</button>
					</div>
					<script type="text/javascript">
						function sendLinkCustom() {
							Kakao.init("5391a7213215108e6b8dc6ea778851ac");
							Kakao.Link.sendCustom({
								templateId : [ 85849 ]
							});
						}
					</script>
					<div>
						<H1 id="status">Status</H1>
						<button id="connect">Connect</button>
						<button id="disconnect">Disconnect</button>
					<h3>To</h3>
					<input type="text" id="target">
					<input type="text" id="totext">
					<button id="sendto">Send</button>
					<div id="to"></div>
					<!-- 수량 조정 form -->
					<form th:action="@{/updatecart}" method="post"
						class="quantity_update_form">
						<input type="hidden" name="cartid" class="update_cartid">
						<input type="hidden" name="cnt" class="update_cnt"> <input
							type="hidden" name="menuid" class="update_menuid"> <input
							type="hidden" name="menuname" class="update_menuname"> <input
							type="hidden" name="price" class="update_price"> <input
							type="hidden" name="menuimg" class="update_menuimg"> <input
							type="hidden" name="custid" th:value="${custid}"
							class="update_custid">
					</form>
				</div>
			</div>
			<!-- class="wrap" -->
		</div>
		<!-- class="wrapper" -->

		<script>
			$(document).ready(function() {
				setTotalInfo();

				$("#connect").click(function() {
					connect();
				});
				$("#disconnect").click(function() {
					disconnect();
				});
				$("#sendto").click(function() {
					sendTo();
				});
			});		
			function sendTo() {
				var msg = JSON.stringify({
					'sendid' : id,
/* 					'receiveid' : $('#target').val(),
					'content1' : $('#totext').val() */
					'receiveid' : 'admin01',
					'content1' : 'test01'
				});
				stompClient.send('/receiveto', {}, msg);
			}
			
			function setConnected(connected) {
				if (connected) {
					$("#status").text("Connected");
				} else {
					$("#status").text("Disconnected");
				}
				
			}
			
			function disconnect() {
				if (stompClient !== null) {
					stompClient.disconnect();
				}
				setConnected(false);
				console.log("Disconnected");
			}
			
			var stompClient = null;
			var id = '[[${session.logincust.custid}]]';
			// 서버소켓에 연결
			function connect() {
				var socket = new SockJS('http://127.0.0.1:8080/admintest/ws');
				stompClient = Stomp.over(socket);
			
				stompClient.connect({}, function(frame) { 
					setConnected(true);
					console.log('Connected: ' + frame);
					stompClient.subscribe('/send/to/'+id, function(msg) { 
						$("#to").prepend(
								"<h4>" + JSON.parse(msg.body).sendid +":"+
								JSON.parse(msg.body).content1
										+ "</h4>");
					});
				});
			}


			$(".individual_cart_checkbox").on("change", function() {
				setTotalInfo($(".cart_info_td"));
			});

			$(".all_check_input").on("click", function() {
				if ($(".all_check_input").prop("checked")) {
					$(".individual_cart_checkbox").attr("checked", true);
				} else {
					$(".individual_cart_checkbox").attr("checked", false);
				}
				return
				setTotalInfo($(".cart_info_td"));

			});

			function setTotalInfo() {

				let totalPrice = 0; // 총 가격
				let totalCount = 0; // 총 갯수
				let totalKind = 0; // 총 종류
				let totalPoint = 0; // 총 마일리지

				$(".cart_info_td").each(
						function(index, element) {

							if ($(element).find(".individual_cart_checkbox")
									.is(":checked") === true) {
								totalPrice += parseInt($(element).find(
										".individual_totalPrice_input").val());
								totalCount += parseInt($(element).find(
										".individual_Cnt_input").val());
								totalKind += 1;
							}

						});

				$(".totalPrice_span").text(totalPrice.toLocaleString());
				$(".totalCount_span").text(totalCount);
				$(".totalKind_span").text(totalKind);
				$(".finalTotalPrice_span").text(totalPrice.toLocaleString());
			}

			$(".plus_btn").on("click", function() {
				let quantity = $(this).parent("div").find("input").val();
				$(this).parent("div").find("input").val(++quantity);
			});
			$(".minus_btn").on("click", function() {
				let quantity = $(this).parent("div").find("input").val();
				if (quantity > 1) {
					$(this).parent("div").find("input").val(--quantity);
				}
			});

			/* 수량 수정 버튼 */
			$(".quantity_modify_btn").on("click", function() {
				let cartid = $(this).data("cartid");
				let custid = $(this).data("custid");
				let menuid = $(this).data("menuid");
				let menuname = $(this).data("menuname");
				let price = $(this).data("price");
				let menuimg = $(this).data("menuimg");
				let totalprice = $(this).data("totalprice");

				let cnt = $(this).parent("td").find("input").val();
				// 위에서 설정한 변수들을 업데이트 시킴
				$(".update_cartid").val(cartid);
				$(".update_cnt").val(cnt);
				$(".update_custid").val(custid);
				$(".update_menuid").val(menuid);
				$(".update_menuname").val(menuname);
				$(".update_price").val(price);
				$(".update_menuimg").val(menuimg);
				$(".update_totalprice").val(totalprice);
				$(".quantity_update_form").submit();

			});

			$.datetimepicker.setLocale('ko');
			$.datetimepicker.setDateFormatter({
			    parseDate: function (date, format) {
			        var d = moment(date, format);
			        return d.isValid() ? d.toDate() : false;
			    },

			    formatDate: function (date, format) {
			        return moment(date).format(format);
			    },

			    //Optional if using mask input
			    formatMask: function(format){
			        return format
			            .replace(/Y{4}/g, '9999')
			            .replace(/Y{2}/g, '99')
			            .replace(/M{2}/g, '19')
			            .replace(/D{2}/g, '39')
			            .replace(/H{2}/g, '29')
			            .replace(/m{2}/g, '59')
			            .replace(/s{2}/g, '59');
			    }
			});
			$('#datetimepicker').datetimepicker({
				  format:'YYYY.M.D H:mm',
				  formatTime:'H:mm',
				  formatDate:'YYYY.M.D',
				  minDate:0,
					inline:true,
					allowTimes:[
						  '09:00', '09:30', '10:00','10:30','11:00', '11:30',
						  '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30',
						  '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00', '20:30', '21:00', '21:30',
						  '22:00', '22:30', '23:00', '23:30',
						 ]
				});

			$('#reserve_btn2').click(function() {
				connect();
				requestPay();

			});
			//I'mpot api test
			var IMP = window.IMP; // 생략 가능
			IMP.init("imp34244488");

			var custid = '[[${session.logincust.custid}]]';//requestPay내부에서 사용할 변수들은 여기서 다 정의해 준다
			var today = new Date();
			var hours = today.getHours(); // 시
			var minutes = today.getMinutes(); // 분
			var seconds = today.getSeconds(); // 초
			var milliseconds = today.getMilliseconds();
			var makeMerchantUid = hours + minutes + seconds + milliseconds;

			function requestPay() {
				var reservedate = $('#datetimepicker').val();
				var totalPrice = $('#totalpricespan span').text();
				var totalPrice2 = parseInt(totalPrice);
				// IMP.request_pay(param, callback) 결제창 호출
				IMP
						.request_pay(
								{ // param
									pg : "html5_inicis",
									pay_method : "card",
									merchant_uid : 'merchant_'
											+ new Date().getTime(),
									name : "Eat&Out",
									amount : totalPrice2 * 2, //여기서 반드시 금액조절 원래는 *1000을 해야 맞는값
									buyer_email : "",
									buyer_name : custid,
									buyer_tel : "010-4242-4242",
									buyer_addr : "서울특별시 강남구 신사동",
									buyer_postcode : "01181",
									m_redirect_url : "118.67.131.90/reserveimpl2?custid="
											+ custid
											+ "&reservedate="
											+ reservedate
								},
								function(rsp) { // callback
									if (rsp.success) {
										jQuery
												.ajax(
														{
															url : "", // 예: https://www.myservice.com/payments/complete
															method : "POST",
															headers : {
																"Content-Type" : "application/json"
															},
															data : {
																imp_uid : rsp.imp_uid, //결제 고유번호     
																merchant_uid : rsp.merchant_uid
															}
														})
												.done(
														function(data) {
															sendLinkDefault();
															sendTo();
															location.href = "[[@{/reserveimpl2?custid=}]]"
																	+ custid
																	+ '&reservedate='
																	+ reservedate
															// 가맹점 서버 결제 API 성공시 로직
														})
									} else {
										alert("결제에 실패하였습니다. 에러 내용: "
												+ rsp.error_msg);
									}
								});
			}
			//pay api end
			try {
				function sendLinkDefault() {
					Kakao.init('5391a7213215108e6b8dc6ea778851ac')
					Kakao.Link
							.sendDefault({
								objectType : 'feed',
								content : {
									title : 'Eat & Out 예약내역 안내',
									imageUrl : '@{/assets/images/eLogo.png}',
									link : {
										mobileWebUrl : 'http://118.67.131.90/login',
										webUrl : 'http://118.67.131.90/login',
									},
								},
								social : {
									likeCount : 286,
									commentCount : 45,
									sharedCount : 845,
								},
								buttons : [
										{
											title : '웹으로 보기',
											link : {
												mobileWebUrl : 'http://118.67.131.90/login',
												webUrl : 'http://118.67.131.90/login',
											},
										},
										{
											title : '앱으로 보기',
											link : {
												mobileWebUrl : 'http://118.67.131.90/login',
												webUrl : 'http://118.67.131.90/login',
											},
										}, ],
							})
				}
				;
				window.kakaoDemoCallback && window.kakaoDemoCallback()
			} catch (e) {
				window.kakaoDemoException && window.kakaoDemoException(e)
			}
		</script>

	</div>

</body>

</html>